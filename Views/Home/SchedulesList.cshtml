@{
    ViewData["Title"] = "Home Page";
    var apiKey = ViewData["GoogleApiKey"];
    const string dateFormat = "MMMM dd";
}

@using Microsoft.AspNetCore.Identity
@inject SignInManager<IdentityUser> SignInManager
@inject UserManager<IdentityUser> UserManager

@if (SignInManager.IsSignedIn(User))
{
    if (ViewBag.Schedules != null)
    {
        <div class="schedule-container">
            @foreach (Schedule schedule in ViewBag.Schedules)
            {
                <div class="schedule-item" data-id="@schedule.Schedule_Id">
                    <button class="delete-schedule-btn" title="Delete schedule">✕</button>
                    <div class="schedule-image">
                        @{
                            string mapUrl;
                            if (!string.IsNullOrWhiteSpace(schedule.Hotel_Id) && !string.IsNullOrWhiteSpace(schedule.Hotel_Name))
                            {
                                // Center on the hotel name and drop a marker there
                                var encodedName = Uri.EscapeDataString(schedule.Hotel_Name);
                                mapUrl =
                                $"https://maps.googleapis.com/maps/api/staticmap?" +
                                $"center={encodedName}" +
                                $"&zoom=15" +
                                $"&size=300x200" +
                                $"&maptype=roadmap" +
                                $"&markers=label:H%7C{encodedName}" +
                                $"&key={apiKey}";
                            }
                            else
                            {
                                // Fallback to city‐center
                                var center = string.IsNullOrWhiteSpace(schedule.City_Name)
                                ? "0,0"
                                : Uri.EscapeDataString(schedule.City_Name);
                                mapUrl =
                                $"https://maps.googleapis.com/maps/api/staticmap?" +
                                $"center={center}" +
                                $"&zoom=13" +
                                $"&size=300x200" +
                                $"&maptype=roadmap" +
                                $"&key={apiKey}";
                            }
                        }
                        <img src="@mapUrl"
                             alt="@(string.IsNullOrWhiteSpace(schedule.Hotel_Name ?? schedule.City_Name)
                                                                 ? "No location selected"
                                                                 : schedule.Hotel_Name ?? schedule.City_Name)" />
                                                                                                    </div>
                                                                                                    <div class="schedule-details">
                                                                                                        <h3>
                            @(string.IsNullOrWhiteSpace(schedule.City_Name)
                                            ? ""
                                            : schedule.City_Name)
            </h3>

                        @* Check if dates are missing or default *@
            @if (schedule.Start_Date == default(DateTime) || schedule.End_Date == default(DateTime) || schedule.Nr_Days <= 0)
                        {
                            <p class="missing-info">
                                <strong>City Break period missing</strong>
                            </p>
                            <a class="btn btn-warning"
                               asp-controller="Home"
                               asp-action="TimePeriod"
                               asp-route-scheduleId="@schedule.Schedule_Id">
                                Select Period
                            </a>
                        }
                        else
                        {
                            <p>
                                <strong>Dates:</strong>
                                @schedule.Start_Date?.ToString(dateFormat)
                                <span> to </span>
                                @schedule.End_Date?.ToString(dateFormat)
                            </p>
                            <p><strong>Number of days:</strong> @schedule.Nr_Days</p>

                            @if (!string.IsNullOrWhiteSpace(schedule.Hotel_Name))
                            {
                                <p><strong>Residence:</strong> @schedule.Hotel_Name</p>
                            }
                        }

                        @* Check if city is missing *@
                        @if (string.IsNullOrWhiteSpace(schedule.City_Name))
                        {
                            <p class="missing-info">
                                <strong>City missing</strong>
                            </p>
                            <a class="btn btn-warning"
                               asp-controller="Home"
                               asp-action="City"
                               asp-route-scheduleId="@schedule.Schedule_Id">
                                Select City
                            </a>
                        }

                        @* Only show View Schedule if both dates and city are present *@
                        @if (schedule.Start_Date != default(DateTime) && schedule.End_Date != default(DateTime) &&
                                    schedule.Nr_Days > 0 && !string.IsNullOrWhiteSpace(schedule.City_Name))
                        {
                            <a class="btn btn-primary"
                               asp-area=""
                               asp-controller="Home"
                               asp-action="ViewSchedule"
                               asp-route-id="@schedule.Schedule_Id">
                                View Schedule
                            </a>
                        }
                    </div>
                </div>
            }
        </div>
    }
}
else
{
    <div class="text-center">
        <h1 class="display-4">Welcome to Travel Agenda</h1>
        <p>Please login</p>
    </div>
}

<link rel="stylesheet" href="~/css/ScheduleList.css" />

@section Scripts {
    <script>
        document.querySelectorAll('.delete-schedule-btn').forEach(btn => {
            btn.addEventListener('click', async e => {
                e.stopPropagation();
                const item = btn.closest('.schedule-item');
                const id = item.dataset.id;
                try {
                    const res = await fetch(`/Home/DeleteSchedule?id=${id}`, { method: 'DELETE' });
                    if (!res.ok) throw new Error('Delete failed');
                    item.remove();
                } catch (err) {
                    console.error(err);
                    alert('Failed to delete schedule. Please try again.');
                }
            });
        });
    </script>
}