@{
    ViewData["Title"] = "Home Page";
    var apiKey = ViewData["GoogleApiKey"];
    const string dateFormat = "MMMM dd";
}

@using Microsoft.AspNetCore.Identity
@inject SignInManager<IdentityUser> SignInManager
@inject UserManager<IdentityUser> UserManager

@if (SignInManager.IsSignedIn(User))
{
    if (ViewBag.Schedules != null)
    {
        <div class="schedule-container">
            @foreach (Schedule schedule in ViewBag.Schedules)
            {
                <div class="schedule-item" data-id="@schedule.Schedule_Id">
                    <button class="delete-schedule-btn" title="Delete schedule">✕</button>
                    <div class="schedule-image">
                        <img src="https://maps.googleapis.com/maps/api/staticmap?center=@(schedule.City_Name ?? "0,0")&zoom=13&size=300x200&maptype=roadmap&key=@apiKey"
                             alt="@(string.IsNullOrWhiteSpace(schedule.City_Name) ? "No city selected" : schedule.City_Name)" />
                    </div>
                    <div class="schedule-details">
                        <h3>@(string.IsNullOrWhiteSpace(schedule.City_Name) ? "(No city selected)" : schedule.City_Name)</h3>
                        <p>
                            <strong>Dates:</strong>
                            @schedule.Start_Date?.ToString(dateFormat)
                            <span> to </span>
                            @schedule.End_Date?.ToString(dateFormat)
                        </p>
                        <p><strong>Number of days:</strong> @schedule.Nr_Days</p>

                        @if (string.IsNullOrWhiteSpace(schedule.City_Name))
                        {
                            <a class="btn btn-warning"
                               asp-controller="Home"
                               asp-action="City"
                               asp-route-scheduleId="@schedule.Schedule_Id">
                                Select City
                            </a>
                        }
                        else
                        {
                            <a class="btn btn-primary"
                               asp-controller="Home"
                               asp-action="ViewSchedule"
                               asp-route-id="@schedule.Schedule_Id">
                                View Schedule
                            </a>
                        }
                    </div>
                </div>
            }

        </div>
    }
}
else
{
    <div class="text-center">
        <h1 class="display-4">Welcome to Travel Agenda</h1>
        <p>Please login</p>
    </div>
}

<style>
    .schedule-container {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;
        gap: 20px;
        padding: 20px;
    }

    .schedule-item {
        position: relative;
        border: 1px solid #ccc;
        border-radius: 8px;
        width: 350px;
        background-color: #f9f9f9;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
        transition: transform 0.3s ease, box-shadow 0.3s ease;
    }

        .schedule-item:hover {
            transform: scale(1.02);
            box-shadow: 0 4px 16px rgba(0,0,0,0.2);
        }

    .delete-schedule-btn {
        position: absolute;
        top: 8px;
        right: 8px;
        background: transparent;
        border: none;
        font-size: 1.2em;
        cursor: pointer;
        color: #888;
    }

        .delete-schedule-btn:hover {
            color: #e74c3c;
        }

    .schedule-image img {
        width: 100%;
        display: block;
    }

    .schedule-details {
        padding: 15px;
        text-align: center;
    }

        .schedule-details h3 {
            margin-top: 0;
            font-size: 1.5em;
        }

        .schedule-details p {
            margin: 10px 0;
            font-size: 0.9em;
        }

    .btn-primary {
        padding: 10px 15px;
        background-color: #007bff;
        border: none;
        color: #fff;
        border-radius: 4px;
        text-decoration: none;
        cursor: pointer;
    }

        .btn-primary:hover {
            background-color: #0056b3;
        }
</style>

@section Scripts {
    <script>
        document.querySelectorAll('.delete-schedule-btn').forEach(btn => {
            btn.addEventListener('click', async e => {
                e.stopPropagation();
                if (!confirm('Are you sure you want to delete this schedule?')) return;
                const item = btn.closest('.schedule-item');
                const id = item.dataset.id;
                try {
                    const res = await fetch(`/Home/DeleteSchedule?id=${id}`, { method: 'DELETE' });
                    if (!res.ok) throw new Error('Delete failed');
                    // Remove from DOM
                    item.remove();
                } catch (err) {
                    console.error(err);
                    alert('Failed to delete schedule. Please try again.');
                }
            });
        });
    </script>
}
