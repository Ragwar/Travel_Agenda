@{
    ViewData["Title"] = "View Schedule";
    var schedule = ViewBag.Schedule as TravelAgenda.Models.Schedule;
    var activities = (ViewBag.Activities as IEnumerable<TravelAgenda.Models.ScheduleActivity>)?.ToList()
                               ?? new List<TravelAgenda.Models.ScheduleActivity>();

    // build date list
    var startDate = schedule.StartDate.Value.Date;
    var daysCount = schedule.NrDays ?? 0;
    var dates = Enumerable.Range(0, daysCount)
                              .Select(i => startDate.AddDays(i))
                              .ToList();
}
<link rel="stylesheet" href="~/css/ViewSchedule.css" />
<div class="header-section">
    <h1>
        Your Trip: @schedule.CityName - @startDate.ToString("MMMM dd, yyyy")
        &ndash;
        @dates.Last().ToString("MMMM dd, yyyy")
    </h1>
    <div class="header-buttons">
        <a class="edit-schedule-btn"
           asp-controller="Home"
           asp-action="LocationsAndActivities"
           asp-route-scheduleId="@schedule.ScheduleId">
            Edit Schedule
        </a>
        <form asp-action="ExportToGoogleCalendar" asp-controller="Home" method="post" style="display: inline;">
            <input type="hidden" name="scheduleId" value="@schedule.ScheduleId" />
            <button type="submit" class="export-calendar-btn">
                Export to Google Calendar
            </button>
        </form>
    </div>
</div>

@if (TempData["SuccessMessage"] != null)
{
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        @TempData["SuccessMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

@if (TempData["ErrorMessage"] != null)
{
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        @TempData["ErrorMessage"]
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<div style="display:flex; gap:20px; overflow-x:auto;">
    @foreach (var date in dates)
    {
        // filter to just this date's activities
        var dayActs = activities
        .Where(a => a.StartDate.HasValue && a.StartDate.Value.Date == date)
        .Select(a => new
        {
            a.Name,
            Start = a.StartHour + ((a.StartMinute ?? 0) / 60.0),
            Duration = (a.EndHour + ((a.EndMinute ?? 0) / 60.0))
        - (a.StartHour + ((a.StartMinute ?? 0) / 60.0))
        })
        .OrderBy(e => e.Start)
        .ToList();

        <div class="day-column">
            <h4 style="text-align:center;">
                @date.ToString("dddd, MMM dd")
            </h4>

            <div class="calendar-container">
                <div class="calendar-header">
                    @date.ToString("yyyy-MM-dd")
                </div>
                <div class="hourSlotsScroll">
                    <div class="hourSlotsContainer">
                        @for (int h = 1; h <= 24; h++)
                        {
                            <div class="hour-slot" style="top:@((h - 1) * 60)px;">
                                <div class="hour-label">
                                    @(h % 12 == 0 ? 12 : h % 12)@(h < 12 ? "AM" : "PM")
                                </div>
                            </div>
                        }

                        @* render only this day's events *@
                        @foreach (var ev in dayActs)
                        {
                            var top = ev.Start * 60;
                            var height = ev.Duration * 60 - 2;  // subtract 2px for borders

                            <div class="event" style="top: @(top)px; height: @(height)px;">
                                <div class="content">@ev.Name</div>
                            </div>
                        }
                    </div>
                </div>
            </div>

            @* Show buttons for this day *@
            <div class="day-buttons">
                @{
                    var hotelName = schedule.HotelName ?? string.Empty;
                    var encodedHotel = Uri.EscapeDataString(hotelName);
                    var stops = dayActs
                    .Where(e => e.Name != hotelName)
                    .Select(e => Uri.EscapeDataString(e.Name));
                    var waypointsParam = string.Join("|", stops);
                    var routeUrl = $"https://www.google.com/maps/dir/?api=1&origin={encodedHotel}&destination={encodedHotel}&travelmode=driving";
                    if (!string.IsNullOrEmpty(waypointsParam))
                    {
                        routeUrl += $"&waypoints={waypointsParam}";
                    }
                }

                <a class="view-day-btn"
                   asp-controller="Home"
                   asp-action="ViewDay"
                   asp-route-scheduleId="@schedule.ScheduleId"
                   asp-route-date="@date.ToString("yyyy-MM-dd")">
                    View Day Details
                </a>

                <a href="@routeUrl" target="_blank" class="route-btn">
                    Show Route in Google Maps
                </a>
            </div>
        </div>
    }
</div>


<script>
    // Once everything's rendered, scroll each day's calendar so that 8 AM is at the top
    window.addEventListener('load', function () {
        // Calculate how many pixels down to put 8 AM (hour 8 means skip 1–7)
        const scrollTo = (8 - 1) * 60; // 7 hours × 60px

        document.querySelectorAll('.hourSlotsScroll').forEach(el => {
            el.scrollTop = scrollTo;
        });
    });
</script>